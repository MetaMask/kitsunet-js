/* eslint-env mocha */
'use strict';
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
require("mocha");
const chai_1 = require("chai");
const events_1 = require("events");
const net_1 = require("../../src/net");
const base_protocol_1 = require("../../src/net/base-protocol");
class FakePeer extends net_1.NetworkPeer {
    constructor(id = '12345', addrs = new Set(['/ip4/127.0.0.1/tcp/5000']), node) {
        super();
        this.used = false;
        this.id = '12345';
        this.addrs = new Set('/ip4/127.0.0.1/tcp/5000');
        this.id = id;
        this.addrs = addrs;
        this.node = node;
    }
    ban(reason) {
        throw new Error('Method not implemented.');
    }
    disconnect(reason) {
        throw new Error('Method not implemented.');
    }
}
class FakeProto extends base_protocol_1.BaseProtocol {
    handshake() {
        return __awaiter(this, void 0, void 0, function* () {
        });
    }
    constructor(id, versions, peer) {
        super(peer, {});
        this.id = id;
        this.versions = versions;
    }
}
describe('peer manager', () => {
    let nodeManager;
    let peerManager;
    let fakePeer;
    beforeEach(() => {
        nodeManager = new events_1.EventEmitter();
        peerManager = new net_1.PeerManager(nodeManager);
        fakePeer = new FakePeer();
    });
    it('should add peer', () => {
        nodeManager.emit('kitsunet:peer:connected', fakePeer);
        chai_1.expect(peerManager.peers.keys()).to.contain('12345');
        chai_1.expect(peerManager.peers.get('12345').peer).to.eql(fakePeer);
    });
    it('should remove peer', () => {
        nodeManager.emit('kitsunet:peer:disconnected', fakePeer);
        chai_1.expect(peerManager.peers).to.not.have.keys('12345');
    });
    it('should retrieve peer by id', () => {
        nodeManager.emit('kitsunet:peer:connected', fakePeer);
        chai_1.expect(peerManager.getById('12345')).to.eql(fakePeer);
        peerManager.reserve([fakePeer]);
        chai_1.expect(peerManager.isUsed(fakePeer)).to.be.eq(true);
    });
    it('should retrieve unused peers', () => {
        const peer1 = new FakePeer('12345');
        const peer2 = new FakePeer('678910');
        const peer3 = new FakePeer('1112131415');
        const peer4 = new FakePeer('1617181920');
        nodeManager.emit('kitsunet:peer:connected', peer1);
        nodeManager.emit('kitsunet:peer:connected', peer2);
        nodeManager.emit('kitsunet:peer:connected', peer3);
        nodeManager.emit('kitsunet:peer:connected', peer4);
        peerManager.reserve([peer3]);
        const peers = peerManager.getUnusedPeers();
        chai_1.expect(peers).to.have.members([peer1, peer2, peer4]);
    });
    it('should retrieve by capability', () => {
        const peer1 = new FakePeer('12345');
        peer1.protocols.set('proto1', new FakeProto('proto1', ['1.0.0'], peer1));
        const peer2 = new FakePeer('678910');
        peer2.protocols.set('proto2', new FakeProto('proto2', ['1.0.0'], peer2));
        const peer3 = new FakePeer('1112131415');
        peer3.protocols.set('proto3', new FakeProto('proto3', ['1.0.0'], peer3));
        const peer4 = new FakePeer('1617181920');
        peer4.protocols.set('proto4', new FakeProto('proto4', ['1.0.0'], peer4));
        nodeManager.emit('kitsunet:peer:connected', peer1);
        nodeManager.emit('kitsunet:peer:connected', peer2);
        nodeManager.emit('kitsunet:peer:connected', peer3);
        nodeManager.emit('kitsunet:peer:connected', peer4);
        const peers = peerManager.getByCapability({ id: 'proto3', versions: ['1.0.0'] });
        chai_1.expect(peers[0]).to.eql(peer3);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVlci1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGVzdC9uZXQvcGVlci1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHNCQUFzQjtBQUV0QixZQUFZLENBQUE7Ozs7Ozs7Ozs7QUFFWixpQkFBYztBQUNkLCtCQUE2QjtBQUU3QixtQ0FBcUM7QUFDckMsdUNBTXNCO0FBQ3RCLCtEQUEwRDtBQUUxRCxNQUFNLFFBQVMsU0FBUSxpQkFBcUI7SUFPMUMsWUFBYSxLQUFhLE9BQU8sRUFDcEIsUUFBcUIsSUFBSSxHQUFHLENBQUMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLEVBQUUsSUFBVTtRQUNoRixLQUFLLEVBQUUsQ0FBQTtRQVJULFNBQUksR0FBWSxLQUFLLENBQUE7UUFFckIsT0FBRSxHQUFXLE9BQU8sQ0FBQTtRQUNwQixVQUFLLEdBQWdCLElBQUksR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUE7UUFPckQsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUE7UUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtJQUNsQixDQUFDO0lBRUQsR0FBRyxDQUFpQixNQUFzQjtRQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUE7SUFDNUMsQ0FBQztJQUVELFVBQVUsQ0FBaUIsTUFBc0I7UUFDL0MsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO0lBQzVDLENBQUM7Q0FDRjtBQUVELE1BQU0sU0FBVSxTQUFRLDRCQUFzQjtJQUN0QyxTQUFTOztRQUNmLENBQUM7S0FBQTtJQUtELFlBQWEsRUFBVSxFQUFFLFFBQWtCLEVBQUUsSUFBYztRQUN6RCxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQW9CLENBQUMsQ0FBQTtRQUNqQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQTtRQUNa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QUFDLENBQUE7UUFDbEQsV0FBVyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNsRCxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsZUFBZSxDQUFDLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDaEYsYUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDaEMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1lbnYgbW9jaGEgKi9cblxuJ3VzZSBzdHJpY3QnXG5cbmltcG9ydCAnbW9jaGEnXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJ1xuXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnXG5pbXBvcnQge1xuICBQZWVyTWFuYWdlcixcbiAgTmV0d29ya1BlZXIsXG4gIE5vZGUsXG4gIE5vZGVNYW5hZ2VyLFxuICBQZWVyXG59IGZyb20gJy4uLy4uL3NyYy9uZXQnXG5pbXBvcnQgeyBCYXNlUHJvdG9jb2wgfSBmcm9tICcuLi8uLi9zcmMvbmV0L2Jhc2UtcHJvdG9jb2wnXG5cbmNsYXNzIEZha2VQZWVyIGV4dGVuZHMgTmV0d29ya1BlZXI8YW55LCBhbnk+IHtcbiAgdXNlZDogYm9vbGVhbiA9IGZhbHNlXG4gIHBlZXI6IGFueVxuICBpZDogc3RyaW5nID0gJzEyMzQ1J1xuICBhZGRyczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCcvaXA0LzEyNy4wLjAuMS90Y3AvNTAwMCcpXG4gIG5vZGU6IE5vZGU8YW55PlxuXG4gIGNvbnN0cnVjdG9yIChpZDogc3RyaW5nID0gJzEyMzQ1JyxcbiAgICAgICAgICAgICAgIGFkZHJzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoWycvaXA0LzEyNy4wLjAuMS90Y3AvNTAwMCddKSwgbm9kZT86IGFueSkge1xuICAgIHN1cGVyKClcblxuICAgIHRoaXMuaWQgPSBpZFxuICAgIHRoaXMuYWRkcnMgPSBhZGRyc1xuICAgIHRoaXMubm9kZSA9IG5vZGVcbiAgfVxuXG4gIGJhbjxSIGV4dGVuZHMgYW55PiAocmVhc29uPzogUiB8IHVuZGVmaW5lZCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKVxuICB9XG5cbiAgZGlzY29ubmVjdDxSIGV4dGVuZHMgYW55PiAocmVhc29uPzogUiB8IHVuZGVmaW5lZCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKVxuICB9XG59XG5cbmNsYXNzIEZha2VQcm90byBleHRlbmRzIEJhc2VQcm90b2NvbDxGYWtlUGVlcj4ge1xuICBhc3luYyBoYW5kc2hha2UgKCk6IFByb21pc2U8dm9pZD4ge1xuICB9XG5cbiAgaWQ6IHN0cmluZ1xuICB2ZXJzaW9uczogc3RyaW5nW11cblxuICBjb25zdHJ1Y3RvciAoaWQ6IHN0cmluZywgdmVyc2lvbnM6IHN0cmluZ1tdLCBwZWVyOiBGYWtlUGVlcikge1xuICAgIHN1cGVyKHBlZXIsIHt9IGFzIE5vZGU8RmFrZVBlZXI+KVxuICAgIHRoaXMuaWQgPSBpZFxuICAgIHRoaXMudmVyc2lvbnMgPSB2ZXJzaW9uc1xuICB9XG59XG5cbmRlc2NyaWJlKCdwZWVyIG1hbmFnZXInLCAoKSA9PiB7XG4gIGxldCBub2RlTWFuYWdlcjogTm9kZU1hbmFnZXI8YW55PlxuICBsZXQgcGVlck1hbmFnZXI6IFBlZXJNYW5hZ2VyXG4gIGxldCBmYWtlUGVlcjogUGVlclxuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG5vZGVNYW5hZ2VyID0gbmV3IEV2ZW50RW1pdHRlcigpIGFzIE5vZGVNYW5hZ2VyPGFueT5cbiAgICBwZWVyTWFuYWdlciA9IG5ldyBQZWVyTWFuYWdlcihub2RlTWFuYWdlcilcbiAgICBmYWtlUGVlciA9IG5ldyBGYWtlUGVlcigpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCBhZGQgcGVlcicsICgpID0+IHtcbiAgICBub2RlTWFuYWdlci5lbWl0KCdraXRzdW5ldDpwZWVyOmNvbm5lY3RlZCcsIGZha2VQZWVyKVxuICAgIGV4cGVjdChwZWVyTWFuYWdlci5wZWVycy5rZXlzKCkpLnRvLmNvbnRhaW4oJzEyMzQ1JylcbiAgICBleHBlY3QocGVlck1hbmFnZXIucGVlcnMuZ2V0KCcxMjM0NScpIS5wZWVyKS50by5lcWwoZmFrZVBlZXIpXG4gIH0pXG5cbiAgaXQoJ3Nob3VsZCByZW1vdmUgcGVlcicsICgpID0+IHtcbiAgICBub2RlTWFuYWdlci5lbWl0KCdraXRzdW5ldDpwZWVyOmRpc2Nvbm5lY3RlZCcsIGZha2VQZWVyKVxuICAgIGV4cGVjdChwZWVyTWFuYWdlci5wZWVycykudG8ubm90LmhhdmUua2V5cygnMTIzNDUnKVxuICB9KVxuXG4gIGl0KCdzaG91bGQgcmV0cmlldmUgcGVlciBieSBpZCcsICgpID0+IHtcbiAgICBub2RlTWFuYWdlci5lbWl0KCdraXRzdW5ldDpwZWVyOmNvbm5lY3RlZCcsIGZha2VQZWVyKVxuICAgIGV4cGVjdChwZWVyTWFuYWdlci5nZXRCeUlkKCcxMjM0NScpKS50by5lcWwoZmFrZVBlZXIpXG4gICAgcGVlck1hbmFnZXIucmVzZXJ2ZShbZmFrZVBlZXJdKVxuICAgIGV4cGVjdChwZWVyTWFuYWdlci5pc1VzZWQoZmFrZVBlZXIpKS50by5iZS5lcSh0cnVlKVxuICB9KVxuXG4gIGl0KCdzaG91bGQgcmV0cmlldmUgdW51c2VkIHBlZXJzJywgKCkgPT4ge1xuICAgIGNvbnN0IHBlZXIxID0gbmV3IEZha2VQZWVyKCcxMjM0NScpXG4gICAgY29uc3QgcGVlcjIgPSBuZXcgRmFrZVBlZXIoJzY3ODkxMCcpXG4gICAgY29uc3QgcGVlcjMgPSBuZXcgRmFrZVBlZXIoJzExMTIxMzE0MTUnKVxuICAgIGNvbnN0IHBlZXI0ID0gbmV3IEZha2VQZWVyKCcxNjE3MTgxOTIwJylcblxuICAgIG5vZGVNYW5hZ2VyLmVtaXQoJ2tpdHN1bmV0OnBlZXI6Y29ubmVjdGVkJywgcGVlcjEpXG4gICAgbm9kZU1hbmFnZXIuZW1pdCgna2l0c3VuZXQ6cGVlcjpjb25uZWN0ZWQnLCBwZWVyMilcbiAgICBub2RlTWFuYWdlci5lbWl0KCdraXRzdW5ldDpwZWVyOmNvbm5lY3RlZCcsIHBlZXIzKVxuICAgIG5vZGVNYW5hZ2VyLmVtaXQoJ2tpdHN1bmV0OnBlZXI6Y29ubmVjdGVkJywgcGVlcjQpXG4gICAgcGVlck1hbmFnZXIucmVzZXJ2ZShbcGVlcjNdKVxuICAgIGNvbnN0IHBlZXJzID0gcGVlck1hbmFnZXIuZ2V0VW51c2VkUGVlcnMoKVxuICAgIGV4cGVjdChwZWVycykudG8uaGF2ZS5tZW1iZXJzKFtwZWVyMSwgcGVlcjIsIHBlZXI0XSlcbiAgfSlcblxuICBpdCgnc2hvdWxkIHJldHJpZXZlIGJ5IGNhcGFiaWxpdHknLCAoKSA9PiB7XG4gICAgY29uc3QgcGVlcjEgPSBuZXcgRmFrZVBlZXIoJzEyMzQ1JylcbiAgICBwZWVyMS5wcm90b2NvbHMuc2V0KCdwcm90bzEnLCBuZXcgRmFrZVByb3RvKCdwcm90bzEnLCBbJzEuMC4wJ10sIHBlZXIxKSlcblxuICAgIGNvbnN0IHBlZXIyID0gbmV3IEZha2VQZWVyKCc2Nzg5MTAnKVxuICAgIHBlZXIyLnByb3RvY29scy5zZXQoJ3Byb3RvMicsIG5ldyBGYWtlUHJvdG8oJ3Byb3RvMicsIFsnMS4wLjAnXSwgcGVlcjIpKVxuXG4gICAgY29uc3QgcGVlcjMgPSBuZXcgRmFrZVBlZXIoJzExMTIxMzE0MTUnKVxuICAgIHBlZXIzLnByb3RvY29scy5zZXQoJ3Byb3RvMycsIG5ldyBGYWtlUHJvdG8oJ3Byb3RvMycsIFsnMS4wLjAnXSwgcGVlcjMpKVxuXG4gICAgY29uc3QgcGVlcjQgPSBuZXcgRmFrZVBlZXIoJzE2MTcxODE5MjAnKVxuICAgIHBlZXI0LnByb3RvY29scy5zZXQoJ3Byb3RvNCcsIG5ldyBGYWtlUHJvdG8oJ3Byb3RvNCcsIFsnMS4wLjAnXSwgcGVlcjQpKVxuXG4gICAgbm9kZU1hbmFnZXIuZW1pdCgna2l0c3VuZXQ6cGVlcjpjb25uZWN0ZWQnLCBwZWVyMSlcbiAgICBub2RlTWFuYWdlci5lbWl0KCdraXRzdW5ldDpwZWVyOmNvbm5lY3RlZCcsIHBlZXIyKVxuICAgIG5vZGVNYW5hZ2VyLmVtaXQoJ2tpdHN1bmV0OnBlZXI6Y29ubmVjdGVkJywgcGVlcjMpXG4gICAgbm9kZU1hbmFnZXIuZW1pdCgna2l0c3VuZXQ6cGVlcjpjb25uZWN0ZWQnLCBwZWVyNClcbiAgICBjb25zdCBwZWVycyA9IHBlZXJNYW5hZ2VyLmdldEJ5Q2FwYWJpbGl0eSh7IGlkOiAncHJvdG8zJywgdmVyc2lvbnM6IFsnMS4wLjAnXSB9KVxuICAgIGV4cGVjdChwZWVyc1swXSkudG8uZXFsKHBlZXIzKVxuICB9KVxufSlcbiJdfQ==